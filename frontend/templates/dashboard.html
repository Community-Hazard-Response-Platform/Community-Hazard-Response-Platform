<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dashboard</title>
<link rel="stylesheet" href="/static/css/style.css">
<link rel="icon" href="../static/images/logo_light.png" type="image/png">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
</head>
<body>

<div id="map">
    <div class="leaflet-control-zoom leaflet-bar">
        <a class="leaflet-control-zoom-in">+</a>
        <a class="leaflet-control-zoom-out">−</a>
    </div>
</div>

<!-- Toggle sidebar button -->
<button id="btn-toggle" class="btn-primary toggle-btn">
    <span class="line"></span>
    <span class="line"></span>
    <span class="line"></span>
</button>


<div class="sidebar" id="sidebar">
    <div class="sidebar-buttons">
        <div class="button-row">
            <button class="btn-primary" id="btn-my-needs">My Needs</button>
            <button class="btn-primary btn-add" id="add-need-btn">+</button>
        </div>

        <div class="button-row">
            <button class="btn-primary" id="btn-my-offers">My Offers</button>
            <button class="btn-primary btn-add" id="add-offer-btn">+</button>
        </div>

        <button class="btn-primary" id="btn-my-assignments">My Assignments</button>
        <button class="btn-primary" id="btn-uncovered">Uncovered Needs</button>
        <button class="btn-primary" id="btn-facilities">Nearest Facilities</button>
        <button class="btn-primary" id="btn-area-stats">Area Stats</button>
        <div class="button-row" id="area-stats-toggle" style="display:none;">
            <button class="btn-primary" id="btn-parishes">Parishes</button>
            <button class="btn-primary" id="btn-municipalities">Municipalities</button>
        </div>
    </div>
        


    <div id="user-profile-link" style="cursor:pointer;" class="user-panel">
        <div class="dashboard-avatar">
            <div class="avatar-circle"></div>
            <div class="avatar-body"></div>
        </div>
        <div class="user-info">
            <span class="username" id="username-display">{{ username }}</span>
        </div>
    </div>
    <button class="btn-logout">Logout</button>


</div>



<!-- Search bar -->
<div class="search-bar"> 
    <select id="filterSelect">
        <option value="needs">Needs</option>
        <option value="offers">Offers</option>
        <option value="facility">Facilities</option>
        <option value="all">All</option>
    </select>

    <select id="facilitySelect"></select>

    <div class="autocomplete-wrapper">
        <input type="text" id="searchInput" placeholder="Search by administrative area...">
        <ul id="suggestions" class="autocomplete-list"></ul>
    </div>
    <button id="searchBtn" class="btn-primary">Search</button>
</div>



<body data-user-id="{{ user_id }}">


<script>

const CURRENT_USER_ID = parseInt(document.body.dataset.userId);




// Start the map
var map = L.map('map', { zoomControl: false }).setView([38.7169, -9.1395], 13); // Lisboa

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

//L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
//    attribution: 'Tiles &copy; Esri'
//}).addTo(map);

L.control.zoom({
    position: 'bottomright'  
}).addTo(map);

// Arrays for the markers
let needMarkers = [];
let offerMarkers = [];
let facilityMarkers = [];
let assignmentMarkers = [];


// Icons for needs and offers
var needIcon = L.icon({
    iconUrl: '/static/images/pin-red.png',
    iconSize: [30, 40],
    iconAnchor: [15, 40],
    popupAnchor: [0, -35]
});

var offerIcon = L.icon({
    iconUrl: '/static/images/pin-green.png',
    iconSize: [30, 40],
    iconAnchor: [15, 40],
    popupAnchor: [0, -35]
});

var assignmentIcon = L.icon({
    iconUrl: '/static/images/pin-blue.png',
    iconSize: [30, 40],
    iconAnchor: [15, 40],
    popupAnchor: [0, -35]
});

const facilityStyles = {
    emergency:  { radius: 6, fillColor: '#d32f2f', color: '#d32f2f', weight: 1, opacity: 1, fillOpacity: 0.9 },
    healthcare: { radius: 6, fillColor: '#0288d1', color: '#0288d1', weight: 1, opacity: 1, fillOpacity: 0.9 },
    shelter:    { radius: 6, fillColor: '#388e3c', color: '#388e3c', weight: 1, opacity: 1, fillOpacity: 0.9 }
};

const emergencyTypes  = ['hospitals', 'hospital', 'fire_stations', 'fire_station', 'police'];
const healthcareTypes = ['clinics', 'clinic', 'pharmacies', 'pharmacy'];
const shelterTypes    = ['schools', 'school', 'universities', 'university', 'community_centres', 'community_centre', 'sports_centres', 'sports_centre'];

function getFacilityStyle(facilityType) {
    if (emergencyTypes.includes(facilityType))  return facilityStyles.emergency;
    if (healthcareTypes.includes(facilityType)) return facilityStyles.healthcare;
    if (shelterTypes.includes(facilityType))    return facilityStyles.shelter;
    return { radius: 5, fillColor: '#888', color: '#888', weight: 1, opacity: 1, fillOpacity: 0.9 };
}

function mercatorToLatLng(x, y) {
    const R = 6378137; 
    const lng = x / R * (180 / Math.PI);
    const lat = (2 * Math.atan(Math.exp(y / R)) - Math.PI / 2) * (180 / Math.PI);
    return [lat, lng];
}

function acceptItem(type, itemId) {
    const confirmAccept = confirm(`Are you sure you want to accept this ${type}?`);
    if (!confirmAccept) return;

    let payload = {};
    if (type === "need") payload.need_id = itemId;
    if (type === "offer") payload.offer_id = itemId;

    fetch("/assignments", {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    })
    .then(res => {
        if (!res.ok) throw new Error("Server error");
        return res.json();
    })
    .then(() => {
        window.location.reload(); // simple y limpio
    })
    .catch(err => {
        console.error(err);
        alert("There was a problem accepting this item.");
    });
}


function addInteractiveMarker(item, type) {

    const geomObj = typeof item.geom === "string" ? JSON.parse(item.geom) : item.geom;
    const [x, y] = geomObj.coordinates;
    const [lat, lng] = mercatorToLatLng(x, y);


    const icon = type === 'need' ? needIcon : offerIcon;

    const marker = L.marker([lat, lng], { icon }).addTo(map);

    const itemId = item.id;  

    const isOwner = item.user_id === CURRENT_USER_ID;

    let popupHTML = `
        <b>${item.title}</b><br>
        ${item.descrip}<br><br>
    `;

    if (isOwner) {
        const editUrl = type === "need" 
            ? `/edit-need/${item.id}` 
            : `/edit-offer/${item.id}`;

        popupHTML += `<button class="btn-primary" onclick="window.location='${editUrl}'">
                Update
            </button>`;
    } else {
        popupHTML += `
            <button class="btn-primary"
                onclick="acceptItem('${type}', ${itemId})">
                Accept
            </button>
        `;
        if (type === 'need') {
            popupHTML += `
                <button class="btn-primary"
                    onclick="showNearestFacilities(${itemId}, '${item.category}')">
                    Nearby Facilities
                </button>
            `;
        }
    }

    marker.bindPopup(popupHTML, {
        closeButton: true
    });

    marker.on("mouseover", function () {
        this.openPopup();
    });

    if (type === 'need') {
        marker.on('click', function() { showNearbyOffers(item.id); });
    }

    if (type === 'need') marker._needId = item.id;
    if (type === 'need') needMarkers.push(marker);
    if (type === 'offer') offerMarkers.push(marker);
}

// Toggle sidebar
const sidebar = document.querySelector(".sidebar");
const toggleBtn = document.getElementById("btn-toggle");

toggleBtn.addEventListener("click", () => {
    sidebar.classList.toggle("open");
    toggleBtn.classList.toggle("sidebar-open"); 

});


// search funtion
function applySearch() {
    const query = document.getElementById("searchInput").value.trim();
    const filter = document.getElementById("filterSelect").value;
    const selectedFacilities = Array.from(facilitySelect.selectedOptions).map(opt => opt.value);

    // Construir query string
    const params = new URLSearchParams();
    if (query) params.append("query", query);
    if (filter) params.append("type", filter);
    selectedFacilities.forEach(f => params.append("facilityTypes", f));

    fetch("/search?" + params.toString())
        .then(res => res.json())
        .then(data => {
            // Limpiar todos los markers
            [...needMarkers, ...offerMarkers, ...facilityMarkers].forEach(m => map.removeLayer(m));
            needMarkers = [];
            offerMarkers = [];
            facilityMarkers = [];

            // Dibujar markers filtrados
            data.needs.forEach(n => {
                addInteractiveMarker({
                    id: n.need_id,
                    title: n.title,
                    descrip: n.descrip,
                    user_id: n.user_id,
                    category: n.category,
                    geom: n.geom
                }, 'need');
            });

            data.offers.forEach(o => {
                addInteractiveMarker({
                    id: o.offer_id,
                    title: o.title,
                    descrip: o.descrip,
                    user_id: o.user_id,
                    geom: o.geom
                }, 'offer');
            });

            data.facility.forEach(f => {
                if (f.geom) {
                    const geomObj = typeof f.geom === 'string' ? JSON.parse(f.geom) : f.geom;
                    const [x, y] = geomObj.coordinates;
                    const [lat, lng] = mercatorToLatLng(x, y);
                    const m = L.circleMarker([lat, lng], getFacilityStyle(f.facility_type))
                                .bindPopup(`<b>${f.name_fac}</b><br>${f.facility_type}`)
                                .addTo(map);
                    facilityMarkers.push(m);
                }
            });


            // ajustar mapa al área de resultados
            const allMarkers = [...needMarkers, ...offerMarkers, ...facilityMarkers];
            if (allMarkers.length > 0) {
                const group = L.featureGroup(allMarkers);
                map.fitBounds(group.getBounds().pad(0.2));
            }
        })
        .catch(err => console.error("Search error:", err));
}



// to bring the facilities
const facilitySelect = document.getElementById("facilitySelect");

fetch("/facility-types")
    .then(res => res.json())
    .then(types => {
        facilitySelect.innerHTML = "";

        const allOption = document.createElement("option");
        allOption.value = "all";
        allOption.text = "All Facilities";
        allOption.selected = true;
        facilitySelect.appendChild(allOption);

        types.forEach(type => {
            const option = document.createElement("option");
            option.value = type;
            option.text = type.charAt(0).toUpperCase() + type.slice(1);
            facilitySelect.appendChild(option);
        });
    });

    // to show markers of needs
    fetch('/needs').then(res => res.json()).then(data => {
        data.features.forEach(f => addInteractiveMarker({
            id: f.properties.need_id,
            title: f.properties.title,
            descrip: f.properties.descrip,
            user_id: f.properties.user_id,
            category: f.properties.category,
            geom: f.geometry
        }, 'need'));
    });


    // to show markers of offers
    fetch('/offers').then(res => res.json()).then(data => {
        data.features.forEach(f => addInteractiveMarker({
            id: f.properties.offer_id,
            title: f.properties.title,
            descrip: f.properties.descrip,
            user_id: f.properties.user_id,
            geom: f.geometry
        }, 'offer'));
    });



    // to show markers of facilities
    fetch('/facilities').then(res => res.json()).then(data => {
        data.features.forEach(f => {
            const [lat, lng] = mercatorToLatLng(f.geometry.coordinates[0], f.geometry.coordinates[1]);
            const m = L.circleMarker([lat, lng], getFacilityStyle(f.properties.facility_type))
                        .bindPopup(`<b>${f.properties.name_fac}</b><br>${f.properties.facility_type}`)
                        .addTo(map);
            facilityMarkers.push(m);
        });
    });

    const logoutBtn = document.querySelector(".btn-logout");

    logoutBtn.addEventListener("click", () => {
        // Show confirmation popup
        const confirmLogout = confirm("Are you sure you want to log out?");
        
        if (confirmLogout) {
            // User confirmed, call the /logout endpoint
            fetch("/logout")
                .then(() => {
                    window.location.href = "/"; // Redirect to login or home page
                })
                .catch(err => console.error("Logout error:", err));
        } else {
            // User cancelled, do nothing
            console.log("Logout cancelled");
        }
    });

    document.getElementById("user-profile-link").addEventListener("click", function() {
        window.location.href = "/profile-page";
    });

    document.getElementById("add-offer-btn").addEventListener("click", function() {
        window.location.href = "/create-offer";
    });

    document.getElementById("add-need-btn").addEventListener("click", function() {
        window.location.href = "/create-need";
    });

    document.getElementById("searchBtn").addEventListener("click", () => {
        applySearch();
    });


    document.getElementById("searchInput").addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
            e.preventDefault();  
            applySearch();
        }
    });

const searchInput = document.getElementById("searchInput");
const suggestions = document.getElementById("suggestions");
let selectedArea = null;

searchInput.addEventListener("input", () => {
    const val = searchInput.value.trim();
    selectedArea = null; // resetear selección

    if (val.length < 2) {
        suggestions.innerHTML = "";
        return;
    }

    fetch(`/admin-areas?q=${encodeURIComponent(val)}`)
        .then(res => res.json())
        .then(data => {
            suggestions.innerHTML = "";
            data.forEach(area => {
                const li = document.createElement("li");
                li.textContent = area.name_area;
                li.dataset.id = area.id;
                li.addEventListener("click", () => {
                    searchInput.value = area.name_area;
                    selectedArea = area.id;
                    suggestions.innerHTML = "";
                });
                suggestions.appendChild(li);
            });
        })
        .catch(err => console.error(err));
});

// Cerrar lista al hacer click fuera
document.addEventListener("click", (e) => {
    if (!searchInput.contains(e.target) && !suggestions.contains(e.target)) {
        suggestions.innerHTML = "";
    }
});

// Al presionar Enter
searchInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
        e.preventDefault();
        if (selectedArea) {
            applySearch(); // tu función existente
        } else {
            alert("Please select a valid administrative area from the list.");
        }
    }
});

function showUserItems(type) {
    // Limpiar todos los markers
    [...needMarkers, ...offerMarkers, ...facilityMarkers, ...assignmentMarkers].forEach(m => map.removeLayer(m));
    needMarkers = [];
    offerMarkers = [];
    facilityMarkers = [];
    assignmentMarkers = [];

    let url = '';
    if (type === 'needs') url = '/my-needs';
    if (type === 'offers') url = '/my-offers';
    if (type === 'assignments') url = '/my-assignments';

    fetch(url)
        .then(res => res.json())
        .then(data => {
            data.features.forEach(item => {
                // solo needs y offers van con addInteractiveMarker
                if(type === 'needs' || type === 'offers') {
                    addInteractiveMarker({
                        id: item.id,
                        title: item.title,
                        descrip: item.descrip,
                        user_id: item.user_id,
                        geom: item.geom
                    }, type.slice(0, -1)); // 'needs' -> 'need', 'offers' -> 'offer'
                }else if(type === 'assignments') {

                    const geomObj = typeof item.geom === "string" ? JSON.parse(item.geom) : item.geom;
                    const [x, y] = geomObj.coordinates;
                    const [lat, lng] = mercatorToLatLng(x, y);

                    const m = L.marker([lat, lng], { icon: assignmentIcon }).addTo(map);

                    m.bindPopup(`
                        <b>${item.title}</b><br>
                        ${item.descrip}
                    `, {
                        closeButton: true
                    });

                    m.on("mouseover", function () {
                        this.openPopup();
                    });

                    assignmentMarkers.push(m);
                }
            });

            const allMarkers = [...needMarkers, ...offerMarkers, ...assignmentMarkers];
            if(allMarkers.length > 0){
                map.fitBounds(L.featureGroup(allMarkers).getBounds().pad(0.2));
            }
        })
        .catch(err => console.error(err));
}

let nearbyLayer = null;
let radiusCircle = null;

function showNearbyOffers(needId) {
    if (nearbyLayer) map.removeLayer(nearbyLayer);
    if (radiusCircle) map.removeLayer(radiusCircle);

    // Shrink all need markers except the clicked one
    needMarkers.forEach(m => {
        if (m._needId !== needId) {
            m.setIcon(L.icon({
                iconUrl: '/static/images/pin-red.png',
                iconSize: [18, 24],
                iconAnchor: [9, 24],
                popupAnchor: [0, -20]
            }));
        }
    });

    // Shrink all offer markers
    offerMarkers.forEach(m => m.setIcon(L.icon({
        iconUrl: '/static/images/pin-green.png',
        iconSize: [18, 24],
        iconAnchor: [9, 24],
        popupAnchor: [0, -20]
    })));

    fetch(`/needs/${needId}/nearby-offers?radius=2000`)
        .then(res => res.json())
        .then(data => {
            if (data.meta.need_geom) {
                const [x, y] = data.meta.need_geom.coordinates;
                const [lat, lng] = mercatorToLatLng(x, y);

                const hasNearby = data.meta.nearby_count > 0;

                radiusCircle = L.circle([lat, lng], {
                    radius: data.meta.radius_m,
                    color: hasNearby ? '#e05c00' : '#d32f2f',
                    fillColor: hasNearby ? '#e05c00' : '#d32f2f',
                    fillOpacity: hasNearby ? 0.06 : 0.12,
                    weight: hasNearby ? 1.5 : 2,
                    dashArray: '6,4'
                }).addTo(map);
            }

            const layers = [];
            data.features.forEach((f, index) => {
                const [x, y] = f.geometry.coordinates;
                const [lat, lng] = mercatorToLatLng(x, y);
                const isNearby = f.properties.proximity === 'nearby';
                const isClosest = index === 0;
                const circleStyle = isClosest
        ? { radius: 14, fillColor: '#00c853', color: '#ffffff', weight: 2.5, fillOpacity: 1 }
        : isNearby
            ? { radius: 10, fillColor: '#00c853', color: '#00c853', weight: 2, fillOpacity: 0.95 }
            : { radius: 7, fillColor: '#80cbc4', color: '#80cbc4', weight: 1, fillOpacity: 0.45 };

                const marker = L.circleMarker([lat, lng], circleStyle)
                    .bindPopup(`
                        <b>${f.properties.title}</b><br>
                        ${f.properties.category}<br>
                        <small>${Math.round(f.properties.distance_m)}m away</small>
                    `);
                layers.push(marker);
            });

            nearbyLayer = L.layerGroup(layers).addTo(map);
        })
        .catch(err => console.error('Nearby offers error:', err));
}

// Shows uncovered needs (no matching offer within 2km) in orange
function showUncoveredNeeds() {
    [...needMarkers, ...offerMarkers, ...facilityMarkers].forEach(m => map.removeLayer(m));
    needMarkers = []; offerMarkers = []; facilityMarkers = [];

    fetch('/needs/uncovered?radius=2000')
        .then(res => res.json())
        .then(data => {
            data.features.forEach(f => {
                const [x, y] = f.geometry.coordinates;
                const [lat, lng] = mercatorToLatLng(x, y);
                const m = L.circleMarker([lat, lng], {
                    radius: 10,
                    fillColor: '#ff6600',
                    color: '#ff6600',
                    weight: 2,
                    fillOpacity: 0.9
                }).bindPopup(`
                    <b>${f.properties.title}</b><br>
                    ${f.properties.category}<br>
                    <span style="color:red"><b>Urgency: ${f.properties.urgency}</b></span><br>
                    <small>No matching offer within 2km</small>
                `).addTo(map);
                needMarkers.push(m);
            });

            if (needMarkers.length > 0) {
                map.fitBounds(L.featureGroup(needMarkers).getBounds().pad(0.3));
            }
            alert(`${data.meta.total_uncovered} uncovered needs found (${data.meta.critical_count} critical)`);
        })
        .catch(err => console.error('Uncovered needs error:', err));
}

// Clear radius and nearby markers when clicking on the map background
map.on('click', function() {
    if (nearbyLayer) {
        map.removeLayer(nearbyLayer);
        nearbyLayer = null;
    }
    if (radiusCircle) {
        map.removeLayer(radiusCircle);
        radiusCircle = null;
    }
    // Restore all markers to normal size
    needMarkers.forEach(m => m.setIcon(needIcon));
    offerMarkers.forEach(m => m.setIcon(offerIcon));
});

// Shows nearest facilities to a need when called from a marker popup
function showNearestFacilities(needId, needCategory) {
    if (nearbyLayer) map.removeLayer(nearbyLayer);

    fetch(`/needs/${needId}/nearest-facilities?limit=5&need_category=${needCategory}`)
        .then(res => res.json())
        .then(data => {
            const layers = [];
            data.features.forEach(f => {
                const [x, y] = f.geometry.coordinates;
                const [lat, lng] = mercatorToLatLng(x, y);
                const baseStyle = getFacilityStyle(f.properties.facility_type);
                const marker = L.circleMarker([lat, lng], {
                    radius: 11,
                    fillColor: baseStyle.fillColor,
                    color: '#ffffff',
                    weight: 2.5,
                    fillOpacity: 1
                }).bindPopup(`
                    <b>${f.properties.name_fac}</b><br>
                    ${f.properties.facility_type}<br>
                    <small>${Math.round(f.properties.distance_m)}m away</small>
                `);
                layers.push(marker);
            });
            nearbyLayer = L.layerGroup(layers).addTo(map);
        })
        .catch(err => console.error('Nearest facilities error:', err));
}

// Shows admin area polygons coloured by gap score (needs minus offers)
function showAreaStats(adminLevel) {
    [...needMarkers, ...offerMarkers, ...facilityMarkers].forEach(m => map.removeLayer(m));
    needMarkers = []; offerMarkers = []; facilityMarkers = [];

    fetch(`/admin-areas/stats?admin_level=${adminLevel}`)
        .then(res => res.json())
        .then(data => {
            data.features.forEach(f => {
                const gap = f.properties.gap_score;
                const color = gap > 2 ? '#d32f2f' : gap > 0 ? '#f9a825' : '#388e3c';

                const layer = L.geoJSON(f.geometry, {
                    style: {
                        fillColor: color,
                        fillOpacity: 0.5,
                        color: '#fff',
                        weight: 0.5
                    }
                }).bindPopup(`
                    <b>${f.properties.name_area}</b><br>
                    Needs: ${f.properties.need_count}<br>
                    Offers: ${f.properties.offer_count}<br>
                    Gap: ${f.properties.gap_score}
                `).addTo(map);

                facilityMarkers.push(layer);
            });
        })
        .catch(err => console.error('Area stats error:', err));
}

// Event listeners
document.getElementById("btn-my-needs").addEventListener("click", () => {
    showUserItems('needs');
});

document.getElementById("btn-my-offers").addEventListener("click", () => {
    showUserItems('offers');
});

document.getElementById("btn-my-assignments").addEventListener("click", () => {
    showUserItems('assignments')
});

document.getElementById("btn-uncovered").addEventListener("click", showUncoveredNeeds);
document.getElementById("btn-facilities").addEventListener("click", () => {
    alert("Click a need marker and use the 'Nearby Facilities' button in the popup.");
});
document.getElementById("btn-area-stats").addEventListener("click", () => {
    const toggle = document.getElementById("area-stats-toggle");
    toggle.style.display = toggle.style.display === 'none' ? 'flex' : 'none';
});

document.getElementById("btn-parishes").addEventListener("click", () => {
    showAreaStats(8);
});

document.getElementById("btn-municipalities").addEventListener("click", () => {
    showAreaStats(6);
});


</script>

</body>
</html>
